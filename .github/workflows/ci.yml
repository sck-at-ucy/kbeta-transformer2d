name: CI

on: [push, pull_request]

jobs:
  test-dev:
    name: Test (dev install)
    runs-on: macos-14  # MLX needs Metal
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: pip install -e ".[dev]"
      - run: pytest -q

  test-wheel:
    name: Test (wheel install)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip build
      - run: python -m build
      - run: pip install dist/*.whl
      # Smoke test CLI with packaged config (epochs=0, so no heavy training)
      - run: |
          python - <<'PY'
          import subprocess, importlib.resources as res
          cfg = res.files("kbeta_transformer2d.configs") / "quick_test.yml"
          subprocess.run([
              "python", "-m", "kbeta_transformer2d.demo_heat2d",
              str(cfg), "--epochs=0"
          ], check=True)
          PY
